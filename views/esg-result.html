<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESGè©•ä¼°çµæœ - åœŸåœ°éŠ€è¡Œç¶ æ˜“é€š (Green 'E' Pass)</title>
    <link rel="icon" type="image/svg+xml" href="/images/plant-sprout-icon.svg">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/chat-assistant.css">
    <style>
        .result-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .result-header {
            background: linear-gradient(135deg, #006633 0%, #00b3b3 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .result-header h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
        }

        .pdf-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .pdf-btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .pdf-btn-primary {
            background: linear-gradient(135deg, #006633 0%, #00b3b3 100%);
            color: white;
        }

        .pdf-btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 2px solid #006633;
        }

        .pdf-btn-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .result-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .card {
            padding: 1.5rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #006633;
            box-shadow: 0 4px 12px rgba(0, 102, 51, 0.1);
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #006633;
            margin: 0.5rem 0;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #999;
        }

        @media (max-width: 768px) {
            .pdf-actions {
                flex-direction: column;
            }

            .pdf-btn {
                width: 100%;
                justify-content: center;
            }

            .result-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <img src="/images/land-bank-logo.jpg" alt="åœŸåœ°éŠ€è¡Œ" class="logo-icon">
                <span>åœŸåœ°éŠ€è¡Œç¶ æ˜“é€š <span style="font-size: 0.85em; font-weight: 400;">(Green 'E' Pass)</span></span>
            </div>
            <ul class="nav-links">
                <li><a href="/">é¦–é </a></li>
                <li><a href="/assessment">ESGè©•ä¼°</a></li>
                <li><a href="/esg-tracker">æ”¹å–„è¿½è¹¤</a></li>
                <li><a href="/sustainability">æ°¸çºŒå¹³å°</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div class="result-container">
            <!-- çµæœé ­éƒ¨ -->
            <div class="result-header">
                <h1>âœ… ESGè©•ä¼°å®Œæˆ</h1>
                <p>æ‚¨çš„ESGè©•ä¼°å·²å®Œæˆï¼Œä»¥ä¸‹ç‚ºè©³ç´°çµæœèˆ‡PDFå•å·</p>
            </div>

            <!-- ç‹€æ…‹æ¶ˆæ¯ -->
            <div id="statusMessage"></div>

            <!-- PDFæ“ä½œæŒ‰éˆ• -->
            <div class="pdf-actions">
                <button class="pdf-btn pdf-btn-primary" id="downloadBtn" onclick="downloadESGPDF()">
                    ğŸ“¥ ä¸‹è¼‰PDFå•å·
                </button>
                <button class="pdf-btn pdf-btn-secondary" id="previewBtn" onclick="previewESGPDF()">
                    ğŸ‘ï¸ é è¦½PDF
                </button>
                <button class="pdf-btn pdf-btn-warning" id="printBtn" onclick="printESGPDF()">
                    ğŸ–¨ï¸ åˆ—å°PDF
                </button>
                <button class="pdf-btn pdf-btn-primary" id="importToTrackerBtn" onclick="importToTracker()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    ğŸ“Š å°å…¥åˆ°æ”¹å–„è¿½è¹¤
                </button>
                <button class="pdf-btn pdf-btn-secondary" onclick="location.href='/'">
                    ğŸ  è¿”å›é¦–é 
                </button>
            </div>

            <!-- è©•ä¼°çµæœæ‘˜è¦ -->
            <div class="result-cards" id="resultCards">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 åœŸåœ°éŠ€è¡Œ | ç¶ æ˜“é€š (Green 'E' Pass)</p>
    </footer>

    <script src="/js/pdf-filler.js"></script>
    <script>
        // å…¨å±€è®Šæ•¸å„²å­˜è©•ä¼°çµæœ
        let currentAssessmentResult = null;
        let currentPDFBlob = null;

        // é é¢åŠ è¼‰åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessmentResult();
        });

        /**
         * å¾localStorageè¼‰å…¥è©•ä¼°çµæœ
         */
        function loadAssessmentResult() {
            const resultStr = localStorage.getItem('esgResult');
            const resultData = localStorage.getItem('esgFullData');
            
            if (!resultStr) {
                showStatus('æ‰¾ä¸åˆ°è©•ä¼°çµæœï¼Œè«‹é‡æ–°é€²è¡Œè©•ä¼°', 'error');
                return;
            }

            try {
                currentAssessmentResult = JSON.parse(resultStr);
                const fullData = resultData ? JSON.parse(resultData) : null;
                
                console.log('âœ… å·²åŠ è¼‰è©•ä¼°çµæœ', currentAssessmentResult);
                console.log('ğŸ“Š æª¢æŸ¥åˆ†æ•¸å­—æ®µ:', {
                    hasE: 'E' in (currentAssessmentResult.scores || {}),
                    hasS: 'S' in (currentAssessmentResult.scores || {}),
                    hasG: 'G' in (currentAssessmentResult.scores || {}),
                    scores: currentAssessmentResult.scores
                });
                
                // å¦‚æœç¼ºå°‘E/S/Gåˆ†æ•¸ï¼Œå˜—è©¦å¾fullData.esgAssessmenté‡æ–°è¨ˆç®—
                if (fullData && fullData.esgAssessment && (!currentAssessmentResult.scores?.E || !currentAssessmentResult.scores?.S || !currentAssessmentResult.scores?.G)) {
                    console.log('âš ï¸ æª¢æ¸¬åˆ°ç¼ºå°‘E/S/Gåˆ†æ•¸ï¼Œå˜—è©¦å¾esgAssessmenté‡æ–°è¨ˆç®—...');
                    
                    // ä½¿ç”¨èˆ‡progress-tracker.jsç›¸åŒçš„è¨ˆç®—é‚è¼¯
                    const normalizedEsgAssessment = normalizeEsgAssessmentForScore(fullData.esgAssessment);
                    const calculatedScores = calculateESGScoresFromNormalized(normalizedEsgAssessment);
                    
                    console.log('âœ… é‡æ–°è¨ˆç®—çš„åˆ†æ•¸:', calculatedScores);
                    
                    // æ›´æ–°scoreså°è±¡
                    if (!currentAssessmentResult.scores) {
                        currentAssessmentResult.scores = {};
                    }
                    currentAssessmentResult.scores.E = calculatedScores.E;
                    currentAssessmentResult.scores.S = calculatedScores.S;
                    currentAssessmentResult.scores.G = calculatedScores.G;
                    currentAssessmentResult.scores.total = calculatedScores.total;
                    
                    // æ›´æ–°localStorageä¸­çš„æ•¸æ“š
                    localStorage.setItem('esgResult', JSON.stringify(currentAssessmentResult));
                    if (fullData) {
                        if (!fullData.scores) fullData.scores = {};
                        fullData.scores.E = calculatedScores.E;
                        fullData.scores.S = calculatedScores.S;
                        fullData.scores.G = calculatedScores.G;
                        fullData.scores.total = calculatedScores.total;
                        localStorage.setItem('esgFullData', JSON.stringify(fullData));
                    }
                    
                    console.log('âœ… å·²æ›´æ–°åˆ†æ•¸ä¸¦ä¿å­˜åˆ°localStorage');
                }
                
                // é¡¯ç¤ºçµæœå¡ç‰‡
                displayResultCards(currentAssessmentResult, fullData);
                
                // è‡ªå‹•é ç”ŸæˆPDF
                generateAndCachePDF(fullData || currentAssessmentResult);
            } catch (error) {
                console.error('âŒ çµæœè§£æéŒ¯èª¤:', error);
                showStatus('è©•ä¼°çµæœè¼‰å…¥å¤±æ•—', 'error');
            }
        }
        
        /**
         * æ¨™æº–åŒ–esgAssessmentå­—æ®µåï¼ˆèˆ‡progress-tracker.jsä¸­çš„é‚è¼¯ä¸€è‡´ï¼‰
         */
        function normalizeEsgAssessmentForScore(esgAssessment) {
            const normalized = {};
            const fieldMapping = {
                // Eæ§‹é¢
                'e1': { target: 'e1', value: 'yes' },
                'e2': { target: 'e2', value: 'yes' },
                'e3': { target: 'e3', value: 'yes' },
                'e4': { target: 'e4', value: 'yes' },
                'e5': { target: 'e5', value: 'yes' },
                'e6': { target: 'e6', value: 'yes' },
                // Sæ§‹é¢
                's1': { target: 's1', value: 'yes' },
                's2': { target: 's2', value: 'yes' },
                's3': { target: 's3', value: 'yes' },
                's4': { target: 's4', value: 'yes' },
                's5': { target: 's5', value: 'yes' },
                // Gæ§‹é¢
                'g1': { target: 'g1', value: 'yes' },
                'g2': { target: 'g2', value: 'yes' },
                'g3': { target: 'g3', value: 'yes' },
                'g4': { target: 'g4', value: 'yes' },
                'g5': { target: 'g5', value: 'yes' },
                'g6': { target: 'g6', value: 'yes' },
                'g7': { target: 'g7', value: 'yes' }
            };
            
            // ç›´æ¥ä½¿ç”¨åŸå§‹å€¼ï¼Œå› ç‚ºå­—æ®µåå·²ç¶“æ˜¯e1, s1ç­‰æ ¼å¼
            Object.keys(esgAssessment).forEach(key => {
                if (key in fieldMapping) {
                    normalized[key] = esgAssessment[key];
                }
            });
            
            return normalized;
        }
        
        /**
         * å¾æ¨™æº–åŒ–çš„esgAssessmentè¨ˆç®—E/S/Gåˆ†æ•¸ï¼ˆèˆ‡progress-tracker.jsä¸­çš„é‚è¼¯ä¸€è‡´ï¼‰
         */
        function calculateESGScoresFromNormalized(normalized) {
            let eScore = 0, sScore = 0, gScore = 0;
            
            // Eæ§‹é¢ï¼ˆ35åˆ†ï¼‰
            if (normalized.e1 === 'yes') eScore += 6;  // ç¯€èƒ½æ¡è³¼
            if (normalized.e2 === 'yes') eScore += 7;  // ç¯€èƒ½æ§ç®¡èˆ‡é‡åŒ–æŒ‡æ¨™
            if (normalized.e3 === 'yes') eScore += 7;  // ç¢³æ’æ¸›é‡è¨ˆç•«
            if (normalized.e4 === 'yes') eScore += 6;  // ç„¡ç’°å¢ƒæ±¡æŸ“è£ç½°
            if (normalized.e5 === 'yes') eScore += 5;  // ç¶ èƒ½å»ºç½®æŠ•è³‡
            if (normalized.e6 === 'yes') eScore += 4;  // å»¢æ£„ç‰©è³‡æºå¾ªç’°åˆ©ç”¨
            
            // Sæ§‹é¢ï¼ˆ35åˆ†ï¼‰
            if (normalized.s1 === 'yes') sScore += 7;  // ç„¡é„°å±…æª¢èˆ‰äº‹ä»¶
            if (normalized.s2 === 'yes') sScore += 8;  // ç„¡å‹å·¥è£ç½°äº‹é …
            if (normalized.s3 === 'yes') sScore += 7;  // å…¬ç›Šæˆ–ç›¸é—œæ¡è³¼
            if (normalized.s4 === 'yes') sScore += 8;  // è˜ç”¨å¼±å‹¢æ—ç¾¤æˆ–å¯¦ç¿’è¨ˆç•«
            if (normalized.s5 === 'yes') sScore += 5;  // æŠ•è³‡ESGç¶ è‰²é‡‘èå•†å“
            
            // Gæ§‹é¢ï¼ˆ30åˆ†ï¼‰
            if (normalized.g1 === 'yes') gScore += 5;  // ä¾ç…§è¦å®šç¹³ç¨…
            if (normalized.g2 === 'yes') gScore += 5;  // ç„¡æ¼é–‹ç™¼ç¥¨ç­‰æ•…æ„äº‹é …
            if (normalized.g3 === 'yes') gScore += 4;  // ç„¡é€ƒæ¼è£ç½°äº‹é …
            if (normalized.g4 === 'yes') gScore += 4;  // è¿‘ä¸‰å¹´çš†æœ‰ç›ˆé¤˜
            if (normalized.g5 === 'yes') gScore += 4;  // å®šæœŸå¬é–‹è‘£äº‹æœƒèªªæ˜è²¡å‹™
            if (normalized.g6 === 'yes') gScore += 4;  // è¨­ç«‹ESGå°ˆè²¬å–®ä½
            if (normalized.g7 === 'yes') gScore += 4;  // ç·¨è£½æ°¸çºŒå ±å‘Šæ›¸
            
            const total = eScore + sScore + gScore;
            
            return { E: eScore, S: sScore, G: gScore, total: total };
        }

        /**
         * é¡¯ç¤ºçµæœå¡ç‰‡
         */
        function displayResultCards(result, fullData) {
            console.log('ğŸ“Š displayResultCards æ¥æ”¶åˆ°çš„ result:', result);
            console.log('ğŸ“Š result.scores:', result.scores);
            console.log('ğŸ“Š result.scores?.E:', result.scores?.E);
            console.log('ğŸ“Š result.scores?.S:', result.scores?.S);
            console.log('ğŸ“Š result.scores?.G:', result.scores?.G);
            console.log('ğŸ“Š result.scores?.total:', result.scores?.total);
            
            const container = document.getElementById('resultCards');
            
            // ç²å–åˆ†æ•¸ï¼Œå„ªå…ˆä½¿ç”¨ç›´æ¥å±¬æ€§ï¼Œç„¶å¾Œæ˜¯detailsï¼Œæœ€å¾Œæ˜¯0
            const eScore = result.scores?.E ?? result.scores?.details?.E ?? 0;
            const sScore = result.scores?.S ?? result.scores?.details?.S ?? 0;
            const gScore = result.scores?.G ?? result.scores?.details?.G ?? 0;
            
            console.log('âœ… æœ€çµ‚ä½¿ç”¨çš„åˆ†æ•¸ - E:', eScore, 'S:', sScore, 'G:', gScore);
            
            const html = `
                <div class="card">
                    <div class="card-title">ğŸ“Š ç¸½è©•ç´š</div>
                    <div class="card-value" style="color: ${getRatingColor(result.rating)};">
                        ${result.rating} ç´š
                    </div>
                    <div class="card-subtitle">${result.ratingDescription}</div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“ˆ ESGè¡¨ç¾</div>
                    <div class="card-value">${result.scores?.esg || 0}%</div>
                    <div class="card-subtitle">å®Œæˆåº¦</div>
                </div>

                <div class="card">
                    <div class="card-title">âœ“ ç¶“æ¿Ÿæ´»å‹•ç¬¦åˆåº¦</div>
                    <div class="card-value">${result.scores?.compliant || 0}%</div>
                    <div class="card-subtitle">Y/T/Nç¬¦åˆç‡</div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸŒ ç’°å¢ƒ(E)</div>
                    <div class="card-value">${eScore}</div>
                    <div class="card-subtitle">ç’°å¢ƒé …ç›®è©•åˆ†</div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ‘¥ ç¤¾æœƒ(S)</div>
                    <div class="card-value">${sScore}</div>
                    <div class="card-subtitle">ç¤¾æœƒé …ç›®è©•åˆ†</div>
                </div>

                <div class="card">
                    <div class="card-title">âš–ï¸ æ²»ç†(G)</div>
                    <div class="card-value">${gScore}</div>
                    <div class="card-subtitle">æ²»ç†é …ç›®è©•åˆ†</div>
                </div>

                ${result.loanDiscount ? `
                <div class="card" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-color: #4caf50;">
                    <div class="card-title">ğŸ’° è²¸æ¬¾å„ªæƒ </div>
                    <div class="card-value" style="color: #2e7d32;">${result.loanDiscount.discountRange}</div>
                    <div class="card-subtitle">${result.loanDiscount.description}</div>
                </div>
                ` : ''}
            `;
            
            container.innerHTML = html;
        }

        /**
         * ç²å–ç­‰ç´šé¡è‰²
         */
        function getRatingColor(rating) {
            const colors = {
                'A': '#006633',
                'B': '#00b3b3',
                'C': '#ff9800',
                'D': '#dc3545'
            };
            return colors[rating] || '#666';
        }

        /**
         * ç”Ÿæˆä¸¦å¿«å–PDF
         */
        async function generateAndCachePDF(data) {
            try {
                console.log('ğŸ”„ æ­£åœ¨ç”ŸæˆPDF...');
                showStatus('æ­£åœ¨æº–å‚™PDFæ–‡ä»¶...', 'info');
                
                currentPDFBlob = await esgPdfFiller.generatePDFFromAssessment(data);
                
                console.log('âœ… PDFå·²ç”Ÿæˆä¸¦å¿«å–');
                showStatus('PDFå·²æº–å‚™å°±ç·’ï¼Œæ‚¨å¯ä»¥ä¸‹è¼‰æˆ–é è¦½', 'success');
                
                // å•Ÿç”¨æŒ‰éˆ•
                enableButtons();
            } catch (error) {
                console.error('âŒ PDFç”Ÿæˆå¤±æ•—:', error);
                showStatus('PDFç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦: ' + error.message, 'error');
                disableButtons();
            }
        }

        /**
         * ä¸‹è¼‰PDF
         */
        function downloadESGPDF() {
            if (!currentPDFBlob) {
                showStatus('PDFæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™...', 'error');
                return;
            }

            try {
                const filename = `ESGè©•ä¼°å•å·_${currentAssessmentResult.companyName || 'å…¬å¸'}_${new Date().toISOString().split('T')[0]}.pdf`;
                esgPdfFiller.downloadPDF(currentPDFBlob, filename);
                showStatus('âœ… PDFå·²é–‹å§‹ä¸‹è¼‰', 'success');
            } catch (error) {
                console.error('âŒ ä¸‹è¼‰å¤±æ•—:', error);
                showStatus('ä¸‹è¼‰å¤±æ•—: ' + error.message, 'error');
            }
        }

        /**
         * é è¦½PDF
         */
        function previewESGPDF() {
            if (!currentPDFBlob) {
                showStatus('PDFæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™...', 'error');
                return;
            }

            try {
                esgPdfFiller.previewPDF(currentPDFBlob);
                showStatus('âœ… PDFå·²åœ¨æ–°è¦–çª—ä¸­æ‰“é–‹', 'success');
            } catch (error) {
                console.error('âŒ é è¦½å¤±æ•—:', error);
                showStatus('é è¦½å¤±æ•—: ' + error.message, 'error');
            }
        }

        /**
         * åˆ—å°PDF
         */
        function printESGPDF() {
            if (!currentPDFBlob) {
                showStatus('PDFæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™...', 'error');
                return;
            }

            try {
                esgPdfFiller.printPDF(currentPDFBlob);
                showStatus('âœ… åˆ—å°å°è©±æ¡†å·²æ‰“é–‹', 'success');
            } catch (error) {
                console.error('âŒ åˆ—å°å¤±æ•—:', error);
                showStatus('åˆ—å°å¤±æ•—: ' + error.message, 'error');
            }
        }

        /**
         * å•Ÿç”¨æŒ‰éˆ•
         */
        function enableButtons() {
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('printBtn').disabled = false;
            const importBtn = document.getElementById('importToTrackerBtn');
            if (importBtn) importBtn.disabled = false;
        }

        /**
         * ç¦ç”¨æŒ‰éˆ•
         */
        function disableButtons() {
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('previewBtn').disabled = true;
            document.getElementById('printBtn').disabled = true;
            const importBtn = document.getElementById('importToTrackerBtn');
            if (importBtn) importBtn.disabled = true;
        }

        /**
         * é¡¯ç¤ºç‹€æ…‹æ¶ˆæ¯
         */
        function showStatus(message, type) {
            const container = document.getElementById('statusMessage');
            container.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;
            
            // 3ç§’å¾Œè‡ªå‹•æ¶ˆé™¤successå’Œinfoæ¶ˆæ¯
            if (type !== 'error') {
                setTimeout(() => {
                    if (container.innerHTML.includes(message)) {
                        container.innerHTML = '';
                    }
                }, 3000);
            }
        }

        /**
         * å°å…¥è©•ä¼°æ•¸æ“šåˆ°æ”¹å–„è¿½è¹¤ç³»çµ±
         */
        function importToTracker() {
            try {
                // æª¢æŸ¥æ˜¯å¦æœ‰è©•ä¼°æ•¸æ“š
                const resultStr = localStorage.getItem('esgResult');
                const fullDataStr = localStorage.getItem('esgFullData');
                
                if (!resultStr || !fullDataStr) {
                    showStatus('âŒ æ‰¾ä¸åˆ°è©•ä¼°æ•¸æ“šï¼Œè«‹å…ˆå®Œæˆè©•ä¼°', 'error');
                    return;
                }

                const result = JSON.parse(resultStr);
                const fullData = JSON.parse(fullDataStr);

                console.log('ğŸ“Š é–‹å§‹å°å…¥è©•ä¼°æ•¸æ“šåˆ°æ”¹å–„è¿½è¹¤ç³»çµ±...', { result, fullData });
                console.log('ğŸ“Š esgAssessment åŸå§‹æ•¸æ“š:', fullData.esgAssessment);

                // å­—æ®µåæ¨™æº–åŒ–ï¼šå°‡ç°¡çŸ­å­—æ®µåï¼ˆe1, e2, s1ç­‰ï¼‰è½‰æ›ç‚ºå®Œæ•´å­—æ®µå
                const rawEsgAssessment = fullData.esgAssessment || {};
                const esgAssessment = {};
                
                // Eæ§‹é¢æ˜ å°„
                if (rawEsgAssessment.e1_carbonManagement) {
                    esgAssessment.e1_carbonManagement = rawEsgAssessment.e1_carbonManagement;
                } else if (rawEsgAssessment.e1) {
                    esgAssessment.e1_carbonManagement = rawEsgAssessment.e1 === 'yes' ? 'completed-scope1-2' : 
                                                       rawEsgAssessment.e1 === 'platform-tool' ? 'platform-tool' :
                                                       rawEsgAssessment.e1 === 'committed-next-year' ? 'committed-next-year' : rawEsgAssessment.e1;
                }
                
                if (rawEsgAssessment.e2_energyEfficiency) {
                    esgAssessment.e2_energyEfficiency = rawEsgAssessment.e2_energyEfficiency;
                } else if (rawEsgAssessment.e2) {
                    esgAssessment.e2_energyEfficiency = rawEsgAssessment.e2 === 'yes' ? 'updated-equipment-past2y' :
                                                       rawEsgAssessment.e2 === 'led-full-replacement' ? 'led-full-replacement' :
                                                       rawEsgAssessment.e2 === 'basic-measures' ? 'basic-measures' : rawEsgAssessment.e2;
                }
                
                if (rawEsgAssessment.e3_waste !== undefined) {
                    esgAssessment.e3_waste = rawEsgAssessment.e3_waste;
                } else if (rawEsgAssessment.e3) {
                    esgAssessment.e3_waste = rawEsgAssessment.e3 === 'yes' ? 'yes' : 'no';
                }
                
                if (rawEsgAssessment.e3_water !== undefined) {
                    esgAssessment.e3_water = rawEsgAssessment.e3_water;
                } else if (rawEsgAssessment.e4) {
                    esgAssessment.e3_water = rawEsgAssessment.e4 === 'yes' ? 'yes' : 'no';
                }
                
                // Sæ§‹é¢æ˜ å°„
                if (rawEsgAssessment.s1_training) {
                    esgAssessment.s1_training = rawEsgAssessment.s1_training;
                } else if (rawEsgAssessment.s1) {
                    esgAssessment.s1_training = rawEsgAssessment.s1 === 'yes' ? 'yes-15hours' :
                                                rawEsgAssessment.s1 === 'basic-training' ? 'basic-training' :
                                                rawEsgAssessment.s1 === 'yes-15hours' ? 'yes-15hours' : rawEsgAssessment.s1;
                }
                
                if (rawEsgAssessment.s2_welfare) {
                    esgAssessment.s2_welfare = rawEsgAssessment.s2_welfare;
                } else if (rawEsgAssessment.s2) {
                    esgAssessment.s2_welfare = rawEsgAssessment.s2 === 'yes' ? 'exceeds-law' :
                                              rawEsgAssessment.s2 === 'basic-insurance' ? 'basic-insurance' :
                                              rawEsgAssessment.s2 === 'exceeds-law' ? 'exceeds-law' : rawEsgAssessment.s2;
                }
                
                if (rawEsgAssessment.s3_supplychain) {
                    esgAssessment.s3_supplychain = rawEsgAssessment.s3_supplychain;
                } else if (rawEsgAssessment.s3) {
                    esgAssessment.s3_supplychain = rawEsgAssessment.s3 === 'yes' ? 'yes' : 'no';
                }
                
                if (rawEsgAssessment.s4_community) {
                    esgAssessment.s4_community = rawEsgAssessment.s4_community;
                } else if (rawEsgAssessment.s4) {
                    esgAssessment.s4_community = rawEsgAssessment.s4 === 'yes' ? 'yes' : 'no';
                }
                
                // Gæ§‹é¢æ˜ å°„
                if (rawEsgAssessment.g1_sustainability) {
                    esgAssessment.g1_sustainability = rawEsgAssessment.g1_sustainability;
                } else if (rawEsgAssessment.g1) {
                    esgAssessment.g1_sustainability = rawEsgAssessment.g1 === 'yes' ? 'executive-with-team' :
                                                    rawEsgAssessment.g1 === 'dedicated-staff' ? 'dedicated-staff' :
                                                    rawEsgAssessment.g1 === 'executive-with-team' ? 'executive-with-team' : rawEsgAssessment.g1;
                }
                
                if (rawEsgAssessment.g2_compliance) {
                    esgAssessment.g2_compliance = rawEsgAssessment.g2_compliance;
                } else if (rawEsgAssessment.g2) {
                    esgAssessment.g2_compliance = rawEsgAssessment.g2 === 'yes' ? 'no-major-violations' :
                                                 rawEsgAssessment.g2 === 'minor-violations-resolved' ? 'minor-violations-resolved' :
                                                 rawEsgAssessment.g2 === 'no-major-violations' ? 'no-major-violations' : rawEsgAssessment.g2;
                }
                
                if (rawEsgAssessment.g3_integrity) {
                    esgAssessment.g3_integrity = rawEsgAssessment.g3_integrity;
                } else if (rawEsgAssessment.g3) {
                    esgAssessment.g3_integrity = rawEsgAssessment.g3 === 'yes' ? 'yes' : 'no';
                }
                
                // Tæ§‹é¢
                if (rawEsgAssessment.t1_platform) esgAssessment.t1_platform = rawEsgAssessment.t1_platform;
                if (rawEsgAssessment.t2_targets) esgAssessment.t2_targets = rawEsgAssessment.t2_targets;
                if (rawEsgAssessment.t3_commitment) esgAssessment.t3_commitment = rawEsgAssessment.t3_commitment;
                
                // å…¼å®¹èˆŠå­—æ®µå
                if (rawEsgAssessment.s1_employeeSatisfaction) esgAssessment.s1_employeeSatisfaction = rawEsgAssessment.s1_employeeSatisfaction;
                if (rawEsgAssessment.s2_community) esgAssessment.s2_community = rawEsgAssessment.s2_community;
                if (rawEsgAssessment.s3_social) esgAssessment.s3_social = rawEsgAssessment.s3_social;
                if (rawEsgAssessment.g1_governanceStructure) esgAssessment.g1_governanceStructure = rawEsgAssessment.g1_governanceStructure;
                if (rawEsgAssessment.g2_riskManagement) esgAssessment.g2_riskManagement = rawEsgAssessment.g2_riskManagement;
                if (rawEsgAssessment.g3_audit) esgAssessment.g3_audit = rawEsgAssessment.g3_audit;
                if (rawEsgAssessment.g4_transparency) esgAssessment.g4_transparency = rawEsgAssessment.g4_transparency;
                if (rawEsgAssessment.g5_ethics) esgAssessment.g5_ethics = rawEsgAssessment.g5_ethics;
                if (rawEsgAssessment.g6_compliance) esgAssessment.g6_compliance = rawEsgAssessment.g6_compliance;
                if (rawEsgAssessment.g7_supplyChain) esgAssessment.g7_supplyChain = rawEsgAssessment.g7_supplyChain;
                
                console.log('ğŸ“Š æ¨™æº–åŒ–å¾Œçš„ esgAssessment:', esgAssessment);

                // è¨ˆç®—E/S/Gåˆ†æ•¸
                let eScore = 0, sScore = 0, gScore = 0;

                // Eæ§‹é¢ï¼še1-e6ï¼ˆæ»¿åˆ†35åˆ†ï¼‰
                if (esgAssessment.e1_carbonManagement === 'completed-scope1-2') eScore += 12;
                else if (esgAssessment.e1_carbonManagement === 'platform-tool') eScore += 6;
                else if (esgAssessment.e1_carbonManagement === 'committed-next-year') eScore += 3;
                else if (esgAssessment.e1 === 'yes') eScore += 6;

                if (esgAssessment.e2_energyEfficiency === 'updated-equipment-past2y') eScore += 10;
                else if (esgAssessment.e2_energyEfficiency === 'led-full-replacement') eScore += 7;
                else if (esgAssessment.e2_energyEfficiency === 'basic-measures') eScore += 4;
                else if (esgAssessment.e2 === 'yes') eScore += 7;

                if (esgAssessment.e3 === 'yes') eScore += 7;
                else {
                    if (esgAssessment.e3_waste === 'yes') eScore += 3;
                    if (esgAssessment.e3_water === 'yes') eScore += 3;
                }
                
                if (esgAssessment.e4 === 'yes') eScore += 6;
                if (esgAssessment.e5 === 'yes') eScore += 5;
                if (esgAssessment.e6 === 'yes') eScore += 4;

                // Sæ§‹é¢ï¼šs1-s5ï¼ˆæ»¿åˆ†35åˆ†ï¼‰
                if (esgAssessment.s1_training === 'yes-15hours') sScore += 10;
                else if (esgAssessment.s1_training === 'basic-training') sScore += 4;
                else if (esgAssessment.s1_employeeSatisfaction === 'yes') sScore += 10;
                else if (esgAssessment.s1 === 'yes') sScore += 7;
                
                if (esgAssessment.s2_welfare === 'exceeds-law') sScore += 10;
                else if (esgAssessment.s2_welfare === 'basic-insurance') sScore += 5;
                else if (esgAssessment.s2_community === 'yes') sScore += 10;
                else if (esgAssessment.s2 === 'yes') sScore += 8;
                
                if (esgAssessment.s3_supplychain === 'yes') sScore += 5;
                else if (esgAssessment.s3_social === 'yes') sScore += 10;
                else if (esgAssessment.s3 === 'yes') sScore += 7;
                
                if (esgAssessment.s4_community === 'yes') sScore += 5;
                else if (esgAssessment.s4 === 'yes') sScore += 8;
                
                if (esgAssessment.s5 === 'yes') sScore += 5;
                
                // Gæ§‹é¢ï¼šg1-g7ï¼ˆæ»¿åˆ†30åˆ†ï¼‰
                if (esgAssessment.g1_sustainability === 'executive-with-team') gScore += 10;
                else if (esgAssessment.g1_sustainability === 'dedicated-staff') gScore += 5;
                else if (esgAssessment.g1_governanceStructure === 'yes') gScore += 5;
                else if (esgAssessment.g1 === 'yes') gScore += 5;
                
                if (esgAssessment.g2_compliance === 'no-major-violations') gScore += 10;
                else if (esgAssessment.g2_compliance === 'minor-violations-resolved') gScore += 5;
                else if (esgAssessment.g2_riskManagement === 'yes') gScore += 3;
                else if (esgAssessment.g2 === 'yes') gScore += 5;
                
                if (esgAssessment.g3_integrity === 'yes') gScore += 5;
                else if (esgAssessment.g3_audit === 'yes') gScore += 3;
                else if (esgAssessment.g3 === 'yes') gScore += 4;
                
                if (esgAssessment.g4 === 'yes') gScore += 4;
                if (esgAssessment.g5 === 'yes') gScore += 4;
                if (esgAssessment.g6 === 'yes') gScore += 4;
                if (esgAssessment.g7 === 'yes') gScore += 4;
                
                // é™åˆ¶Gåˆ†æ•¸ä¸è¶…é30åˆ†ï¼ˆæ»¿åˆ†ï¼‰
                gScore = Math.min(gScore, 30);

                // è¨ˆç®—ç¸½åˆ†ï¼ˆä¸å†åŒ…å«Tæ§‹é¢ï¼‰
                const backendScores = result.scores || {};
                
                // è¨ˆç®—ç¸½åˆ†ï¼šE35 + S35 + G30 = 100
                const calculatedTotal = eScore + sScore + gScore;
                
                // å¦‚æœå¾Œç«¯è¿”å›çš„esgæ˜¯ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦å‰‡ä½¿ç”¨è¨ˆç®—çš„ç¸½åˆ†
                let totalScore = calculatedTotal;
                if (backendScores.esg && backendScores.esg > 0 && backendScores.esg <= 100 && calculatedTotal === 0) {
                    // åªæœ‰åœ¨è¨ˆç®—ç¸½åˆ†ç‚º0æ™‚æ‰ä½¿ç”¨å¾Œç«¯çš„ç™¾åˆ†æ¯”
                    totalScore = Math.round(backendScores.esg);
                }
                
                console.log('ğŸ“Š åˆ†æ•¸è¨ˆç®—çµæœ:', {
                    eScore: eScore,
                    sScore: sScore,
                    gScore: gScore,
                    calculatedTotal: calculatedTotal,
                    backendEsg: backendScores.esg,
                    finalTotal: totalScore,
                    esgAssessmentKeys: Object.keys(esgAssessment)
                });

                // å‰µå»ºè©•ä¼°è¨˜éŒ„
                const now = Date.now();
                const assessment = {
                    id: `assessment_${now}`,
                    date: fullData.date || new Date().toISOString().split('T')[0],
                    timestamp: now,
                    scores: {
                        total: totalScore,
                        E: eScore,
                        S: sScore,
                        G: gScore,
                        compliant: backendScores.compliant || 0,
                        esg: backendScores.esg || totalScore
                    },
                    rating: result.rating || 'D',
                    ratingDescription: result.ratingDescription || '',
                    environmentalData: {
                        scope1Emissions: fullData.scope1Emissions || 0,
                        scope2Emissions: fullData.scope2Emissions || 0,
                        electricityUsage: fullData.electricityUsage || 0,
                        waterUsage: fullData.waterUsage || 0
                    },
                    details: esgAssessment
                };

                // ç²å–æˆ–å‰µå»ºæ­·å²æ•¸æ“š
                let historyData = {
                    companyId: fullData.companyTaxId || 'default',
                    companyName: fullData.companyName || 'ä¼æ¥­',
                    assessments: [],
                    achievements: [],
                    metadata: {
                        lastUpdated: new Date().toISOString(),
                        totalAssessments: 0
                    }
                };

                const existingHistory = localStorage.getItem('esgHistory');
                if (existingHistory) {
                    try {
                        historyData = JSON.parse(existingHistory);
                        // ç¢ºä¿æ•¸çµ„å­˜åœ¨
                        if (!historyData.assessments) historyData.assessments = [];
                        if (!historyData.achievements) historyData.achievements = [];
                    } catch (e) {
                        console.warn('âš ï¸ æ­·å²æ•¸æ“šè§£æå¤±æ•—ï¼Œå°‡å‰µå»ºæ–°çš„', e);
                    }
                }

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡è¤‡ï¼‰
                const exists = historyData.assessments.some(a => 
                    Math.abs(a.timestamp - assessment.timestamp) < 10000 // 10ç§’å…§
                );

                if (exists) {
                    showStatus('âš ï¸ æ­¤è©•ä¼°å·²å­˜åœ¨æ–¼æ”¹å–„è¿½è¹¤ç³»çµ±ä¸­', 'info');
                    // ä»ç„¶è·³è½‰åˆ°è¿½è¹¤é é¢
                    setTimeout(() => {
                        window.location.href = '/esg-tracker';
                    }, 1500);
                    return;
                }

                // æ·»åŠ åˆ°æ­·å²è¨˜éŒ„
                historyData.assessments.push(assessment);
                historyData.assessments.sort((a, b) => a.timestamp - b.timestamp);
                historyData.metadata.lastUpdated = new Date().toISOString();
                historyData.metadata.totalAssessments = historyData.assessments.length;

                // æ›´æ–°å…¬å¸ä¿¡æ¯
                if (fullData.companyName) historyData.companyName = fullData.companyName;
                if (fullData.companyTaxId) historyData.companyId = fullData.companyTaxId;

                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('esgHistory', JSON.stringify(historyData));

                console.log('âœ… è©•ä¼°æ•¸æ“šå·²å°å…¥åˆ°æ”¹å–„è¿½è¹¤ç³»çµ±:', {
                    assessmentId: assessment.id,
                    totalScore: assessment.scores.total,
                    rating: assessment.rating,
                    totalAssessments: historyData.assessments.length
                });

                showStatus('âœ… å·²æˆåŠŸå°å…¥åˆ°æ”¹å–„è¿½è¹¤ç³»çµ±ï¼æ­£åœ¨è·³è½‰...', 'success');

                // è·³è½‰åˆ°æ”¹å–„è¿½è¹¤é é¢
                setTimeout(() => {
                    window.location.href = '/esg-tracker';
                }, 1500);

            } catch (error) {
                console.error('âŒ å°å…¥å¤±æ•—:', error);
                showStatus('âŒ å°å…¥å¤±æ•—ï¼š' + error.message, 'error');
            }
        }
    </script>
    <script src="/js/chat-assistant.js"></script>
</body>
</html>


